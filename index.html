<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lead Finder CRM</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <style>
        /* Your original full CSS here ‚Äì I'm keeping it complete */
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; background:#f5f7fa; color:#2d3748; line-height:1.6; }
        .container { max-width:1400px; margin:0 auto; padding:20px; }
        header { background:white; padding:24px; border-radius:8px; box-shadow:0 1px 3px rgba(0,0,0,0.1); margin-bottom:24px; }
        h1 { font-size:28px; font-weight:600; color:#1a202c; margin-bottom:8px; }
        .subtitle { color:#718096; font-size:14px; }
        .controls { background:white; padding:20px 24px; border-radius:8px; box-shadow:0 1px 3px rgba(0,0,0,0.1); margin-bottom:24px; display:flex; gap:16px; flex-wrap:wrap; align-items:center; }
        .btn { padding:12px 24px; border:none; border-radius:6px; font-size:14px; font-weight:500; cursor:pointer; transition:all 0.2s; }
        .btn-primary { background:#3b82f6; color:white; }
        .btn-primary:hover { background:#2563eb; }
        .btn-success { background:#10b981; color:white; }
        .btn-success:hover { background:#059669; }
        .btn-export { background:#8b5cf6; color:white; }
        .btn-export:hover { background:#7c3aed; }
        .file-upload-btn { position:relative; overflow:hidden; }
        .file-upload-btn input[type="file"] { position:absolute; left:-9999px; }
        .filter-group { display:flex; gap:12px; align-items:center; margin-left:auto; }
        input[type="search"] { padding:8px 12px; border:1px solid #cbd5e0; border-radius:6px; font-size:14px; width:250px; }
        select { padding:8px 12px; border:1px solid #cbd5e0; border-radius:6px; font-size:14px; background:white; }
        .stats { background:white; padding:16px 24px; border-radius:8px; box-shadow:0 1px 3px rgba(0,0,0,0.1); margin-bottom:24px; display:flex; gap:32px; flex-wrap:wrap; }
        .stat-item { display:flex; flex-direction:column; }
        .stat-label { font-size:12px; color:#718096; text-transform:uppercase; letter-spacing:0.5px; }
        .stat-value { font-size:24px; font-weight:600; color:#1a202c; }
        .tabs { background:white; border-radius:8px 8px 0 0; box-shadow:0 1px 3px rgba(0,0,0,0.1); display:flex; border-bottom:2px solid #e2e8f0; overflow-x:auto; }
        .tab { padding:16px 20px; font-size:14px; font-weight:500; color:#718096; cursor:pointer; border-bottom:3px solid transparent; transition:all 0.2s; white-space:nowrap; flex-shrink:0; }
        .tab:hover { background:#f7fafc; }
        .tab.active { color:#3b82f6; border-bottom-color:#3b82f6; }
        .tab-badge { background:#e2e8f0; color:#4a5568; padding:2px 8px; border-radius:10px; font-size:12px; margin-left:8px; font-weight:600; }
        .tab.active .tab-badge { background:#dbeafe; color:#1e40af; }
        .leads-container { background:white; border-radius:0 0 8px 8px; box-shadow:0 1px 3px rgba(0,0,0,0.1); }
        .leads-header { padding:16px 24px; border-bottom:1px solid #e2e8f0; font-weight:600; color:#4a5568; font-size:14px; }
        .lead-card { border-bottom:1px solid #e2e8f0; padding:16px 24px; cursor:pointer; transition:background 0.15s; }
        .lead-card:hover { background:#f7fafc; }
        .lead-card:last-child { border-bottom:none; }
        .lead-header { display:flex; align-items:center; gap:16px; }
        .lead-icon {
            width:48px; height:48px; border-radius:8px;
            background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display:flex; align-items:center; justify-content:center;
            color:white; font-weight:600; font-size:20px; flex-shrink:0;
        }
        .lead-info { flex:1; }
        .lead-name { font-size:16px; font-weight:600; color:#1a202c; margin-bottom:4px; }
        .lead-website { font-size:14px; color:#ef4444; word-break:break-all; }
        .lead-actions { display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
        .status-badge { padding:4px 12px; border-radius:12px; font-size:12px; font-weight:500; }
        .status-down { background:#fee2e2; color:#991b1b; }
        .move-dropdown { padding:8px 12px; border:1px solid #cbd5e0; border-radius:6px; font-size:13px; background:white; cursor:pointer; }
        .move-dropdown:hover { border-color:#3b82f6; }
        .lead-details { display:none; margin-top:16px; padding-top:16px; border-top:1px solid #e2e8f0; }
        .lead-details.expanded { display:block; }
        .detail-label { font-size:12px; font-weight:600; color:#4a5568; text-transform:uppercase; margin-bottom:8px; }
        textarea { width:100%; padding:12px; border:1px solid #cbd5e0; border-radius:6px; font-size:14px; min-height:80px; }
        /* ... keep other styles like modals, loading, etc. from your original if needed ... */
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Lead Finder CRM</h1>
            <p class="subtitle">Upload CSV ‚Üí finds businesses with down websites (using server proxy)</p>
        </header>

        <div class="controls">
            <label class="btn btn-success file-upload-btn">
                üìÅ Upload CSV File
                <input type="file" id="csvFileInput" accept=".csv" onchange="if(window.app){app.handleCSVUpload(event)}else{alert('App still loading ‚Äì refresh page')}">
            </label>
            <button class="btn btn-export" onclick="if(window.app){app.exportToExcel()}else{alert('App not ready')}">
                üìä Export to Excel
            </button>
            <div class="filter-group">
                <input type="search" id="searchInput" placeholder="Search business names...">
            </div>
        </div>

        <div class="stats">
            <div class="stat-item"><span class="stat-label">Total Leads</span><span class="stat-value" id="totalLeads">0</span></div>
            <div class="stat-item"><span class="stat-label">Open Leads</span><span class="stat-value" id="openLeads">0</span></div>
            <!-- Add your other stat items back as needed -->
        </div>

        <div class="tabs">
            <div class="tab active" data-tab="open" id="openTab">Open <span class="tab-badge" id="openBadge">0</span></div>
            <div class="tab" data-tab="contacted" id="contactedTab">Contacted <span class="tab-badge" id="contactedBadge">0</span></div>
            <div class="tab" data-tab="email-found" id="emailFoundTab">Email Found <span class="tab-badge" id="emailFoundBadge">0</span></div>
            <div class="tab" data-tab="no-email" id="noEmailTab">No Email <span class="tab-badge" id="noEmailBadge">0</span></div>
            <div class="tab" data-tab="closed" id="closedTab">Closed <span class="tab-badge" id="closedBadge">0</span></div>
        </div>

        <div class="leads-container">
            <div class="leads-header"><span id="currentTabLabel">Open Leads</span></div>
            <div class="loading" id="loadingState"><div class="spinner"></div><div>Processing...</div></div>
            <div class="empty-state" id="emptyState">
                <div class="empty-state-title">No leads yet</div>
                <p>Upload CSV with a "Website" column</p>
            </div>
            <div id="leadsList"></div>
        </div>
    </div>

    <!-- Sale modal and other modals ‚Äì add back your original if needed -->

    <script>
        console.log("Script started");

        const BACKEND_URL = 'lead-finder-proxy-git-main-tradesitesetups-projects.vercel.app'; // ‚Üê YOUR REAL URL HERE

        class CSVParser {
            parse(csvText) {
                const lines = csvText.split(/\r?\n/);
                return lines.map(line => {
                    // Basic CSV split with quote handling
                    const row = [];
                    let cell = '';
                    let inQuote = false;
                    for (let char of line) {
                        if (char === '"' && !inQuote) { inQuote = true; continue; }
                        if (char === '"' && inQuote) { inQuote = false; continue; }
                        if (char === ',' && !inQuote) { row.push(cell.trim()); cell = ''; continue; }
                        cell += char;
                    }
                    row.push(cell.trim());
                    return row;
                });
            }

            findColumn(headers, keywords) {
                const lower = headers.map(h => h.toLowerCase().trim());
                for (let kw of keywords) {
                    const idx = lower.findIndex(h => h === kw || h.includes(kw));
                    if (idx !== -1) return idx;
                }
                return -1;
            }
        }

        class WebsiteChecker {
            async checkWebsite(url) {
                try {
                    const res = await fetch(`${BACKEND_URL}/check?url=${encodeURIComponent(url)}`);
                    if (!res.ok) throw new Error('Proxy failed');
                    return await res.json();
                } catch (err) {
                    return { status: 'down', details: err.message };
                }
            }
        }

        class CRMApp {
            constructor() {
                this.parser = new CSVParser();
                this.checker = new WebsiteChecker();
                this.leads = []; // add localStorage later if needed
                console.log("App created");
                this.init();
            }

            init() {
                this.cacheElements();
                this.attachListeners();
                this.render();
            }

            cacheElements() {
                this.els = {
                    leadsList: document.getElementById('leadsList'),
                    loadingState: document.getElementById('loadingState'),
                    emptyState: document.getElementById('emptyState'),
                    searchInput: document.getElementById('searchInput'),
                    // add tabs, stats, etc.
                };
            }

            attachListeners() {
                this.els.searchInput?.addEventListener('input', () => this.render());
            }

            async handleCSVUpload(event) {
                const file = event.target.files[0];
                if (!file) return;
                console.log("CSV selected:", file.name);

                this.els.loadingState.classList.add('active');
                this.els.emptyState.style.display = 'none';

                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const text = e.target.result;
                        const rows = this.parser.parse(text);
                        if (rows.length < 1) throw new Error('Empty file');

                        const headers = rows[0];
                        const websiteIdx = this.parser.findColumn(headers, ['website', 'url', 'site']);
                        if (websiteIdx === -1) throw new Error('No "Website" or "URL" column found');

                        const nameIdx = this.parser.findColumn(headers, ['business', 'company', 'name']);
                        const addressIdx = this.parser.findColumn(headers, ['address']);

                        const newLeads = [];
                        for (let i = 1; i < rows.length; i++) {
                            const row = rows[i];
                            const rawUrl = row[websiteIdx]?.trim();
                            if (!rawUrl) continue;

                            const url = rawUrl.startsWith('http') ? rawUrl : 'https://' + rawUrl;
                            const check = await this.checker.checkWebsite(url);

                            if (check.status === 'down') {
                                newLeads.push({
                                    id: Date.now() + Math.random(),
                                    businessName: (nameIdx >= 0 ? row[nameIdx] : 'Unknown').trim(),
                                    website: url,
                                    address: addressIdx >= 0 ? row[addressIdx]?.trim() : '',
                                    status: 'not-contacted',
                                    moveToAction: 'open',
                                    notes: '',
                                    saleAmount: 0,
                                    dateAdded: new Date().toISOString()
                                });
                            }
                        }

                        this.leads = newLeads;
                        this.render();
                    } catch (err) {
                        console.error(err);
                        alert("Processing failed: " + err.message);
                    } finally {
                        this.els.loadingState.classList.remove('active');
                        event.target.value = '';
                    }
                };
                reader.readAsText(file);
            }

            render() {
                const list = this.els.leadsList;
                list.innerHTML = '';

                if (this.leads.length === 0) {
                    this.els.emptyState.style.display = 'block';
                    return;
                }

                this.els.emptyState.style.display = 'none';

                this.leads.forEach(lead => {
                    const card = document.createElement('div');
                    card.className = 'lead-card';
                    card.innerHTML = `
                        <div class="lead-header">
                            <div class="lead-icon">${lead.businessName.slice(0,2).toUpperCase()}</div>
                            <div class="lead-info">
                                <div class="lead-name">${lead.businessName}</div>
                                <div class="lead-website">üî¥ ${lead.website}</div>
                            </div>
                            <div class="lead-actions">
                                <span class="status-badge status-down">Website Down</span>
                                <select class="move-dropdown" onchange="app.updateLeadStatus(${lead.id}, this.value)">
                                    <option value="open">Open</option>
                                    <option value="contacted">Contacted</option>
                                    <option value="email-found">Email Found</option>
                                    <option value="no-email">No Email</option>
                                    <option value="closed">Closed</option>
                                </select>
                            </div>
                        </div>
                        <div class="lead-details">
                            <div class="detail-label">Notes</div>
                            <textarea placeholder="Add notes..." onchange="app.updateNotes(${lead.id}, this.value)">${lead.notes || ''}</textarea>
                        </div>
                    `;
                    card.onclick = (e) => {
                        if (!e.target.matches('select, textarea')) card.querySelector('.lead-details').classList.toggle('expanded');
                    };
                    list.appendChild(card);
                });
            }

            updateLeadStatus(id, newTab) {
                const lead = this.leads.find(l => l.id === id);
                if (lead) lead.moveToAction = newTab;
                this.render(); // refresh view
            }

            updateNotes(id, notes) {
                const lead = this.leads.find(l => l.id === id);
                if (lead) lead.notes = notes;
            }

            exportToExcel() {
                if (this.leads.length === 0) return alert('No leads');
                const data = this.leads.map(l => ({
                    'Business Name': l.businessName,
                    'Website': l.website,
                    'Address': l.address || '',
                    'Status': l.moveToAction,
                    'Notes': l.notes || ''
                }));
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Leads");
                XLSX.writeFile(wb, "leads.xlsx");
            }
        }

        console.log("Script ready ‚Äì waiting for DOM");

        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM loaded ‚Äì initializing app");
            window.app = new CRMApp();
            console.log("App initialized");
        });
    </script>
</body>
</html>
