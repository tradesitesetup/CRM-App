<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lead Finder CRM</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f7fa; color: #2d3748; line-height:1.6;
        }
        .container { max-width:1400px; margin:0 auto; padding:20px; }
        header { background:white; padding:24px; border-radius:8px; box-shadow:0 1px 3px rgba(0,0,0,0.1); margin-bottom:24px; }
        h1 { font-size:28px; font-weight:600; color:#1a202c; margin-bottom:8px; }
        .subtitle { color:#718096; font-size:14px; }
        .controls { background:white; padding:20px 24px; border-radius:8px; box-shadow:0 1px 3px rgba(0,0,0,0.1); margin-bottom:24px; display:flex; gap:16px; flex-wrap:wrap; align-items:center; }
        .btn { padding:12px 24px; border:none; border-radius:6px; font-size:14px; font-weight:500; cursor:pointer; transition:all 0.2s; }
        .btn-primary { background:#3b82f6; color:white; }
        .btn-primary:hover { background:#2563eb; }
        .btn-success { background:#10b981; color:white; }
        .btn-success:hover { background:#059669; }
        .btn-export { background:#8b5cf6; color:white; }
        .btn-export:hover { background:#7c3aed; }
        .file-upload-btn { position:relative; overflow:hidden; }
        .file-upload-btn input[type="file"] { position:absolute; left:-9999px; }
        .filter-group { display:flex; gap:12px; align-items:center; margin-left:auto; }
        select, input[type="search"] { padding:8px 12px; border:1px solid #cbd5e0; border-radius:6px; font-size:14px; background:white; }
        input[type="search"] { width:250px; }
        .stats { background:white; padding:16px 24px; border-radius:8px; box-shadow:0 1px 3px rgba(0,0,0,0.1); margin-bottom:24px; display:flex; gap:32px; flex-wrap:wrap; }
        .stat-item { display:flex; flex-direction:column; }
        .stat-label { font-size:12px; color:#718096; text-transform:uppercase; letter-spacing:0.5px; }
        .stat-value { font-size:24px; font-weight:600; color:#1a202c; }
        .tabs { background:white; border-radius:8px 8px 0 0; box-shadow:0 1px 3px rgba(0,0,0,0.1); display:flex; border-bottom:2px solid #e2e8f0; overflow-x:auto; }
        .tab { padding:16px 20px; font-size:14px; font-weight:500; color:#718096; cursor:pointer; text-align:center; border-bottom:3px solid transparent; margin-bottom:-2px; transition:all 0.2s; white-space:nowrap; flex-shrink:0; }
        .tab:hover { background:#f7fafc; }
        .tab.active { color:#3b82f6; border-bottom-color:#3b82f6; }
        .tab-badge { display:inline-block; background:#e2e8f0; color:#4a5568; padding:2px 8px; border-radius:10px; font-size:12px; margin-left:8px; font-weight:600; }
        .tab.active .tab-badge { background:#dbeafe; color:#1e40af; }
        .leads-container { background:white; border-radius:0 0 8px 8px; box-shadow:0 1px 3px rgba(0,0,0,0.1); overflow:hidden; }
        .leads-header { padding:16px 24px; border-bottom:1px solid #e2e8f0; font-weight:600; color:#4a5568; font-size:14px; }
        .lead-card { border-bottom:1px solid #e2e8f0; padding:20px 24px; cursor:pointer; transition:background 0.15s; }
        .lead-card:hover { background:#f7fafc; }
        .lead-card:last-child { border-bottom:none; }
        .lead-header { display:flex; align-items:flex-start; gap:16px; }
        .lead-icon { width:48px; height:48px; border-radius:8px; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); display:flex; align-items:center; justify-content:center; color:white; font-weight:600; font-size:20px; flex-shrink:0; }
        .lead-info { flex:1; }
        .lead-name { font-size:16px; font-weight:600; color:#1a202c; margin-bottom:6px; }
        .lead-website { font-size:14px; color:#ef4444; margin-bottom:4px; font-weight:500; }
        .lead-actions { display:flex; align-items:center; gap:16px; flex-wrap:wrap; }
        .status-badge { padding:4px 12px; border-radius:12px; font-size:12px; font-weight:500; }
        .status-down { background:#fee2e2; color:#991b1b; }
        .status-not-contacted { background:#fef3c7; color:#92400e; }
        .status-contacted { background:#dbeafe; color:#1e40af; }
        .status-email-found { background:#dcfce7; color:#166534; }
        .status-no-email { background:#fef3c7; color:#92400e; }
        .status-closed { background:#f3f4f6; color:#6b7280; }
        .move-dropdown { padding:8px 12px; border:1px solid #cbd5e0; border-radius:6px; font-size:13px; background:white; cursor:pointer; color:#4a5568; font-weight:500; }
        .move-dropdown:hover { border-color:#3b82f6; }
        .lead-details { margin-top:16px; padding-top:16px; border-top:1px solid #e2e8f0; display:none; }
        .lead-details.expanded { display:block; }
        .detail-label { font-size:12px; font-weight:600; color:#4a5568; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:8px; }
        textarea { width:100%; padding:12px; border:1px solid #cbd5e0; border-radius:6px; font-size:14px; min-height:80px; }
        .empty-state { padding:60px 24px; text-align:center; color:#718096; }
        .empty-state-icon { font-size:48px; margin-bottom:16px; }
        .empty-state-title { font-size:18px; font-weight:600; color:#4a5568; margin-bottom:8px; }
        .loading { display:none; padding:40px; text-align:center; color:#718096; }
        .loading.active { display:block; }
        .spinner { border:3px solid #e2e8f0; border-top-color:#3b82f6; border-radius:50%; width:40px; height:40px; animation:spin 0.8s linear infinite; margin:0 auto 16px; }
        @keyframes spin { to { transform:rotate(360deg); } }
        @media (max-width: 768px) {
            .filter-group { margin-left:0; width:100%; }
            input[type="search"] { width:100%; }
            .stats { flex-direction:column; gap:16px; }
            .lead-header { flex-wrap:wrap; }
            .lead-actions { width:100%; justify-content:space-between; }
        }
    </style>
</head>
<body>

    <!-- Full-page loading overlay -->
    <div id="appLoading" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.95); display:flex; align-items:center; justify-content:center; z-index:9999; transition:opacity 0.5s;">
        <div style="text-align:center;">
            <div class="spinner"></div>
            <p style="margin-top:20px; font-size:18px;">Loading Lead Finder CRM...</p>
        </div>
    </div>

    <div class="container">
        <header>
            <h1>Lead Finder CRM</h1>
            <p class="subtitle">Upload CSV ‚Üí finds businesses with down websites (using server proxy)</p>
        </header>

        <div class="controls">
            <button class="btn btn-success" onclick="triggerFileUpload()">üìÅ Upload CSV File</button>
            <input type="file" id="csvFileInput" accept=".csv" style="display:none" onchange="if(window.app) app.handleCSVUpload(event)">
            <button class="btn btn-export" onclick="if(window.app) app.exportToExcel(); else alert('App still loading ‚Äì wait a moment')">
                üìä Export to Excel
            </button>
            <div class="filter-group">
                <input type="search" id="searchInput" placeholder="Search business names..." oninput="if(window.app) app.handleFilter()">
            </div>
        </div>

        <div class="stats">
            <div class="stat-item"><span class="stat-label">Total Leads</span><span class="stat-value" id="totalLeads">0</span></div>
            <div class="stat-item"><span class="stat-label">Open Leads</span><span class="stat-value" id="openLeads">0</span></div>
            <div class="stat-item"><span class="stat-label">Contacted</span><span class="stat-value" id="contactedCount">0</span></div>
            <div class="stat-item"><span class="stat-label">Email Found</span><span class="stat-value" id="emailFoundCount">0</span></div>
            <div class="stat-item"><span class="stat-label">No Email</span><span class="stat-value" id="noEmailCount">0</span></div>
            <div class="stat-item"><span class="stat-label">Closed</span><span class="stat-value" id="closedCount">0</span></div>
        </div>

        <div class="tabs">
            <div class="tab active" data-tab="open" id="openTab">Open <span class="tab-badge" id="openBadge">0</span></div>
            <div class="tab" data-tab="contacted" id="contactedTab">Contacted <span class="tab-badge" id="contactedBadge">0</span></div>
            <div class="tab" data-tab="email-found" id="emailFoundTab">Email Found <span class="tab-badge" id="emailFoundBadge">0</span></div>
            <div class="tab" data-tab="no-email" id="noEmailTab">No Email <span class="tab-badge" id="noEmailBadge">0</span></div>
            <div class="tab" data-tab="closed" id="closedTab">Closed <span class="tab-badge" id="closedBadge">0</span></div>
        </div>

        <div class="leads-container">
            <div class="leads-header"><span id="currentTabLabel">Open Leads</span></div>
            <div class="loading" id="loadingState">
                <div class="spinner"></div>
                <div id="loadingText">Processing...</div>
            </div>
            <div class="empty-state" id="emptyState">
                <div class="empty-state-icon">üìã</div>
                <div class="empty-state-title">No leads yet</div>
                <p>Upload a CSV file to find leads with down websites</p>
            </div>
            <div id="leadsList"></div>
        </div>
    </div>

    <script>
        // ===========================================
        // YOUR API LINK ‚Äì LINKED HERE
        // ===========================================
        const BACKEND_URL = 'https://lead-finder-proxy-git-main-tradesitesetups-projects.vercel.app';

        // Trigger file input safely
        function triggerFileUpload() {
            if (!window.app) {
                alert('App is still loading ‚Äì please wait 2‚Äì3 seconds and try again.');
                return;
            }
            document.getElementById('csvFileInput').click();
        }

        class CSVParser {
            parse(csvText) {
                const lines = csvText.split(/\r?\n/).map(l => l.trim()).filter(l => l);
                if (lines.length === 0) return [];
                return lines.map(line => {
                    const row = [];
                    let cell = '';
                    let inQuote = false;
                    for (let char of line) {
                        if (char === '"' && !inQuote) { inQuote = true; continue; }
                        if (char === '"' && inQuote) { inQuote = false; continue; }
                        if (char === ',' && !inQuote) { row.push(cell.trim()); cell = ''; continue; }
                        cell += char;
                    }
                    row.push(cell.trim());
                    return row;
                });
            }

            findColumn(headers, keywords) {
                const lower = headers.map(h => h.toLowerCase().trim());
                return lower.findIndex(h => keywords.some(k => h === k || h.includes(k)));
            }

            isValidURL(url) {
                if (!url) return false;
                return /(https?:\/\/|www\.|[a-zA-Z0-9-]+\.(com|org|net|io|co|edu|gov))/i.test(url.trim());
            }

            normalizeURL(url) {
                url = url.trim();
                if (!url.startsWith('http')) return 'https://' + url;
                return url;
            }
        }

        class WebsiteChecker {
            async checkWebsite(url) {
                try {
                    const res = await fetch(`${BACKEND_URL}/check?url=${encodeURIComponent(url)}`);
                    if (!res.ok) throw new Error(`Proxy error ${res.status}`);
                    return await res.json();
                } catch (err) {
                    return { status: 'down', details: err.message || 'Failed to connect' };
                }
            }
        }

        class CRMApp {
            constructor() {
                this.state = { leads: [], currentTab: 'open' };
                this.parser = new CSVParser();
                this.checker = new WebsiteChecker();
                console.log("CRMApp created");
            }

            async handleCSVUpload(event) {
                const file = event.target.files[0];
                if (!file) return;

                const loading = document.getElementById('loadingState');
                loading.classList.add('active');

                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const rows = this.parser.parse(e.target.result);
                        if (rows.length < 1) throw new Error('Empty CSV');

                        const headers = rows[0];
                        const websiteIdx = this.parser.findColumn(headers, ['website', 'url']);
                        if (websiteIdx === -1) throw new Error('No "Website" or "URL" column found');

                        const nameIdx = this.parser.findColumn(headers, ['business', 'company', 'name']);

                        const newLeads = [];
                        for (let i = 1; i < rows.length; i++) {
                            const row = rows[i];
                            const rawUrl = row[websiteIdx]?.trim();
                            if (!rawUrl || !this.parser.isValidURL(rawUrl)) continue;

                            const url = this.parser.normalizeURL(rawUrl);
                            const check = await this.checker.checkWebsite(url);

                            if (check.status === 'down') {
                                newLeads.push({
                                    id: Date.now() + Math.random(),
                                    businessName: nameIdx >= 0 ? row[nameIdx]?.trim() || 'Unknown' : 'Unknown',
                                    website: url,
                                    moveToAction: 'open',
                                    status: 'not-contacted',
                                    notes: '',
                                    dateAdded: new Date().toISOString()
                                });
                            }
                        }

                        this.state.leads.push(...newLeads);
                        this.render();
                    } catch (err) {
                        alert("Error: " + err.message);
                    } finally {
                        loading.classList.remove('active');
                        event.target.value = '';
                    }
                };
                reader.readAsText(file);
            }

            render() {
                const list = document.getElementById('leadsList');
                list.innerHTML = '';

                const filtered = this.state.leads.filter(l => l.moveToAction === this.state.currentTab);

                if (filtered.length === 0) {
                    document.getElementById('emptyState').style.display = 'block';
                    return;
                }

                document.getElementById('emptyState').style.display = 'none';

                filtered.forEach(lead => {
                    const card = document.createElement('div');
                    card.className = 'lead-card';
                    card.innerHTML = `
                        <div class="lead-header">
                            <div class="lead-icon">${lead.businessName.slice(0,2).toUpperCase()}</div>
                            <div class="lead-info">
                                <div class="lead-name">${lead.businessName}</div>
                                <div class="lead-website">üî¥ ${lead.website}</div>
                            </div>
                            <div class="lead-actions">
                                <span class="status-badge status-down">Website Down</span>
                                <select class="move-dropdown" onchange="app.changeTab('${lead.id}', this.value)">
                                    <option value="open" ${lead.moveToAction === 'open' ? 'selected' : ''}>Open</option>
                                    <option value="contacted" ${lead.moveToAction === 'contacted' ? 'selected' : ''}>Contacted</option>
                                    <option value="email-found" ${lead.moveToAction === 'email-found' ? 'selected' : ''}>Email Found</option>
                                    <option value="no-email" ${lead.moveToAction === 'no-email' ? 'selected' : ''}>No Email</option>
                                    <option value="closed" ${lead.moveToAction === 'closed' ? 'selected' : ''}>Closed</option>
                                </select>
                            </div>
                        </div>
                    `;
                    list.appendChild(card);
                });

                // Update tab badges (simple count)
                ['open', 'contacted', 'email-found', 'no-email', 'closed'].forEach(tab => {
                    const count = this.state.leads.filter(l => l.moveToAction === tab).length;
                    document.getElementById(`${tab.replace('-','')}Badge`).textContent = count;
                });
            }

            changeTab(leadId, newTab) {
                const lead = this.state.leads.find(l => l.id === leadId);
                if (lead) {
                    lead.moveToAction = newTab;
                    this.render();
                }
            }
        }

        // Create app as soon as possible
        window.app = new CRMApp();

        // Hide loading overlay when everything is ready
        window.addEventListener('load', () => {
            const loading = document.getElementById('appLoading');
            if (loading) loading.style.display = 'none';
            console.log("App fully ready");
        });
    </script>
</body>
</html>
