<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lead Finder CRM</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; background:#f5f7fa; color:#2d3748; line-height:1.6; }
        .container { max-width:1400px; margin:0 auto; padding:20px; }
        header { background:white; padding:24px; border-radius:8px; box-shadow:0 1px 3px rgba(0,0,0,0.1); margin-bottom:24px; }
        h1 { font-size:28px; font-weight:600; color:#1a202c; margin-bottom:8px; }
        .subtitle { color:#718096; font-size:14px; }
        .controls { background:white; padding:20px 24px; border-radius:8px; box-shadow:0 1px 3px rgba(0,0,0,0.1); margin-bottom:24px; display:flex; gap:16px; flex-wrap:wrap; align-items:center; }
        .btn { padding:12px 24px; border:none; border-radius:6px; font-size:14px; font-weight:500; cursor:pointer; transition:all 0.2s; }
        .btn-primary { background:#3b82f6; color:white; }
        .btn-primary:hover { background:#2563eb; }
        .btn-success { background:#10b981; color:white; }
        .btn-success:hover { background:#059669; }
        .btn-export { background:#8b5cf6; color:white; }
        .btn-export:hover { background:#7c3aed; }
        .file-upload-btn { position:relative; overflow:hidden; }
        .file-upload-btn input[type="file"] { position:absolute; left:-9999px; }
        .filter-group { display:flex; gap:12px; align-items:center; margin-left:auto; }
        input[type="search"] { padding:8px 12px; border:1px solid #cbd5e0; border-radius:6px; font-size:14px; width:250px; }
        .stats { background:white; padding:16px 24px; border-radius:8px; box-shadow:0 1px 3px rgba(0,0,0,0.1); margin-bottom:24px; display:flex; gap:32px; flex-wrap:wrap; }
        .stat-item { display:flex; flex-direction:column; }
        .stat-label { font-size:12px; color:#718096; text-transform:uppercase; }
        .stat-value { font-size:24px; font-weight:600; color:#1a202c; }
        .tabs { background:white; border-radius:8px 8px 0 0; box-shadow:0 1px 3px rgba(0,0,0,0.1); display:flex; border-bottom:2px solid #e2e8f0; overflow-x:auto; }
        .tab { padding:16px 20px; font-size:14px; font-weight:500; color:#718096; cursor:pointer; border-bottom:3px solid transparent; transition:all 0.2s; white-space:nowrap; }
        .tab:hover { background:#f7fafc; }
        .tab.active { color:#3b82f6; border-bottom-color:#3b82f6; }
        .tab-badge { background:#e2e8f0; color:#4a5568; padding:2px 8px; border-radius:10px; font-size:12px; margin-left:8px; font-weight:600; }
        .tab.active .tab-badge { background:#dbeafe; color:#1e40af; }
        .leads-container { background:white; border-radius:0 0 8px 8px; box-shadow:0 1px 3px rgba(0,0,0,0.1); }
        .leads-header { padding:16px 24px; border-bottom:1px solid #e2e8f0; font-weight:600; color:#4a5568; }
        .lead-card { padding:16px 24px; border-bottom:1px solid #e2e8f0; cursor:pointer; transition:background 0.15s; }
        .lead-card:hover { background:#f7fafc; }
        .lead-card:last-child { border-bottom:none; }
        .lead-header { display:flex; align-items:center; gap:16px; }
        .lead-icon {
            width:40px; height:40px; border-radius:6px;
            background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display:flex; align-items:center; justify-content:center;
            color:white; font-weight:bold; font-size:18px; flex-shrink:0;
        }
        .lead-info { flex:1; }
        .lead-name { font-weight:bold; font-size:16px; color:#1a202c; }
        .lead-website { font-size:14px; color:#ef4444; margin-top:4px; word-break:break-all; }
        .loading { display:none; padding:40px; text-align:center; }
        .loading.active { display:block; }
        .spinner { border:4px solid #e2e8f0; border-top:4px solid #3b82f6; border-radius:50%; width:40px; height:40px; animation:spin 1s linear infinite; margin:0 auto 16px; }
        @keyframes spin { to { transform:rotate(360deg); } }
        .empty-state { padding:80px 24px; text-align:center; color:#718096; }
        .empty-state-title { font-size:20px; font-weight:600; margin-bottom:8px; }
        /* Keep your other styles (stats, modals, tabs, etc.) - abbreviated here for focus */
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Lead Finder CRM</h1>
            <p class="subtitle">Upload CSV data to find businesses with down websites (using server proxy)</p>
        </header>

        <div class="controls">
            <label class="btn btn-success file-upload-btn">
                Upload CSV File
                <input type="file" id="csvFileInput" accept=".csv" onchange="if(window.app){app.handleCSVUpload(event)}else{console.error('App not ready');alert('App still loading â€“ try again in 2 seconds')}">
            </label>
            <button class="btn btn-export" onclick="if(window.app){app.exportToExcel()}else{alert('App not ready')}">
                Export to Excel
            </button>
            <div class="filter-group">
                <input type="search" id="searchInput" placeholder="Search business names...">
            </div>
        </div>

        <div class="stats">
            <!-- Your original stats boxes here â€“ kept as is -->
            <div class="stat-item"><span class="stat-label">Total Leads</span><span class="stat-value" id="totalLeads">0</span></div>
            <!-- ... add the rest ... -->
        </div>

        <div class="tabs">
            <!-- Your tabs here -->
        </div>

        <div class="leads-container">
            <div class="leads-header"><span id="currentTabLabel">Open Leads</span></div>
            <div class="loading" id="loadingState">
                <div class="spinner"></div>
                <div id="loadingText">Processing CSV...</div>
            </div>
            <div class="empty-state" id="emptyState">
                <div class="empty-state-title">No leads yet</div>
                <p>Upload a CSV with a "Website" column</p>
            </div>
            <div id="leadsList"></div>
        </div>
    </div>

    <!-- Your modals here if needed -->

    <script>
        console.log("Script started loading...");

        const BACKEND_URL = 'lead-finder-proxy-git-main-tradesitesetups-projects.vercel.app'; // â† CHANGE TO YOUR REAL VERCEL URL

        class CSVParser {
            parse(csvText) {
                // Your improved parser code here...
                // (copy from previous versions or keep simple split for now)
                const lines = csvText.split(/\r?\n/);
                return lines.map(line => line.split(',').map(cell => cell.trim().replace(/^"|"$/g, '')));
            }

            findWebsiteColumn(headers) {
                const lowerHeaders = headers.map(h => h.toLowerCase().trim());
                const index = lowerHeaders.findIndex(h => h === 'website' || h.includes('website') || h === 'url' || h.includes('url'));
                if (index === -1) throw new Error('CSV must have a column named "Website" (case-insensitive)');
                return index;
            }
        }

        class WebsiteChecker {
            constructor() { this.backendUrl = BACKEND_URL; }
            async checkWebsite(url) {
                try {
                    const res = await fetch(`${this.backendUrl}/check?url=${encodeURIComponent(url)}`);
                    if (!res.ok) throw new Error('Proxy error');
                    return await res.json();
                } catch (err) {
                    return { status: 'down', details: err.message };
                }
            }
        }

        class CRMApp {
            constructor() {
                console.log("CRMApp constructor called");
                this.parser = new CSVParser();
                this.checker = new WebsiteChecker();
                this.leads = []; // simplified for now â€“ add localStorage later if needed
                this.init();
            }

            init() {
                console.log("CRMApp init called");
                this.cacheElements();
                this.render(); // initial empty render
            }

            cacheElements() {
                this.els = {
                    leadsList: document.getElementById('leadsList'),
                    loadingState: document.getElementById('loadingState'),
                    emptyState: document.getElementById('emptyState'),
                    // add others as needed
                };
            }

            async handleCSVUpload(event) {
                const file = event.target.files[0];
                if (!file) return;
                console.log("CSV upload started:", file.name);

                this.els.loadingState.classList.add('active');
                this.els.emptyState.style.display = 'none';

                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const text = e.target.result;
                        const rows = this.parser.parse(text);
                        if (rows.length < 1) throw new Error('Empty CSV');

                        const headers = rows[0];
                        const websiteCol = this.parser.findWebsiteColumn(headers);

                        const newLeads = [];
                        for (let i = 1; i < rows.length; i++) {
                            const url = rows[i][websiteCol];
                            if (!url || !url.trim()) continue;

                            const normalized = url.startsWith('http') ? url : 'https://' + url;
                            const result = await this.checker.checkWebsite(normalized);

                            if (result.status === 'down') {
                                newLeads.push({
                                    businessName: rows[i][0] || 'Unknown', // assume first column is name
                                    website: normalized
                                });
                            }
                        }

                        this.leads = newLeads;
                        this.render();
                    } catch (err) {
                        console.error("Processing failed:", err);
                        alert("Error: " + err.message);
                    } finally {
                        this.els.loadingState.classList.remove('active');
                    }
                };
                reader.readAsText(file);
            }

            render() {
                console.log("Rendering leads:", this.leads.length);
                if (this.leads.length === 0) {
                    this.els.emptyState.style.display = 'block';
                    this.els.leadsList.innerHTML = '';
                    return;
                }

                this.els.emptyState.style.display = 'none';
                this.els.leadsList.innerHTML = this.leads.map(lead => `
                    <div class="lead-card">
                        <div class="lead-header">
                            <div class="lead-icon">${lead.businessName.slice(0,2).toUpperCase()}</div>
                            <div class="lead-info">
                                <div class="lead-name">${lead.businessName}</div>
                                <div class="lead-website">ðŸ”´ ${lead.website}</div>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
        }

        console.log("Classes defined â€“ waiting for DOM");

        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM ready â€“ creating CRMApp");
            window.app = new CRMApp();
            console.log("CRMApp created â€“ ready");
        });
    </script>
</body>
</html>
